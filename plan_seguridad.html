<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Certificado de Plan de Seguridad</title>
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; font-family: 'Roboto', sans-serif; }
    body { background-color: #f4f6f9; color: #333; padding-bottom: 70px; }
    header { background: #2F338F; color: white; text-align: center; padding: 1.5rem 1rem; box-shadow: 0 2px 5px rgba(0,0,0,0.15); }
    header img { max-height: 70px; display: block; margin: 0 auto 0.5rem; }
    header h1 { font-size: 1.4rem; font-weight: bold; }
    header p { font-size: 0.9rem; opacity: 0.9; }
    .container { max-width: 1000px; margin: 2rem auto; background: white; padding: 2rem; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
    h2 { text-align: center; color: #2F338F; font-size: 1.6rem; margin-bottom: 1.5rem; }
    label { font-size: 0.95rem; color: #555; margin-bottom: 4px; display: block; }
    input, select, button { width: 100%; padding: 12px; margin-top: 6px; border: 1px solid #ccc; border-radius: 8px; font-size: 1rem; transition: border-color 0.3s; }
    input:focus, select:focus { border-color: #2F338F; outline: none; }
    button { background-color: #2F338F; color: white; font-weight: bold; cursor: pointer; border: none; transition: background-color 0.3s ease; }
    button:hover { background-color: #24286a; }
    .form-section { margin-bottom: 1rem; }
    form { display: grid; grid-template-columns: 1fr 1fr; gap: 1rem 2rem; }
    form button { grid-column: span 2; }
    footer { position: fixed; bottom: 0; left: 0; width: 100%; background: #2F338F; color: white; text-align: center; padding: 0.8rem; font-size: 0.85rem; }
    @media (max-width: 768px) { form { grid-template-columns: 1fr; } form button { grid-column: span 1; } }
  </style>
</head>
<body>

<header>
  <img src="Logo el NUEVO ECUADOR.png" alt="Logo SNGRE">
  <h1>Secretar√≠a Nacional de Gesti√≥n de Riesgos</h1>
  <p>Coordinaci√≥n Zonal 5-8 | Uso Interno y Personal</p>
</header>

<div class="container">
  <h2>Certificado de Aprobaci√≥n de Plan de Seguridad</h2>

  <form id="formulario">
    <div class="form-section"><label>Evento Deportivo:</label><input type="text" id="evento" required></div>
    <div class="form-section"><label>Presentado por:</label><input type="text" id="presentadoPor" required></div>
    <div class="form-section"><label>C√©dula de Identidad:</label><input type="text" id="cedula" required></div>
    <div class="form-section"><label>Lugar del Evento:</label><input type="text" id="lugar" required></div>
    <div class="form-section"><label>Provincia:</label>
      <select id="provincia" required>
        <option value="">Seleccione una provincia</option>
        <option value="Guayas">Guayas</option>
      </select>
    </div>
    <div class="form-section"><label>Ciudad:</label>
      <select id="ciudad" required>
        <option value="">Seleccione una ciudad</option>
        <option value="Guayaquil">Guayaquil</option>
      </select>
    </div>
    <div class="form-section"><label>Fecha:</label><input type="date" id="fechaEvento" required></div>
    <div class="form-section"><label>Hora de inicio:</label><input type="time" id="horaInicio" required></div>
    <div class="form-section"><label>Hora de finalizaci√≥n:</label><input type="time" id="horaFin" required></div>
    <div class="form-section"><label>Aforo:</label><input type="number" id="aforo" required></div>
    <div class="form-section"><label>Estado del Tr√°mite:</label>
      <select id="estado" required>
        <option value="Aprobado">Aprobado</option>
        <option value="Rechazado">Rechazado</option>
      </select>
    </div>
    <div class="form-section"><label>Fecha de Emisi√≥n:</label><input type="date" id="fechaEmision" required></div>
    <button type="submit" id="generateBtn">Generar Certificado</button>
  </form>
</div>

<footer>
  ¬© 2025 Secretar√≠a Nacional de Gesti√≥n de Riesgos - CZ 5-8 | Uso Interno
</footer>

<script>
const scriptURL = "https://script.google.com/macros/s/AKfycbytT0oZfISPXP7ZKY1Mod8qljqxFxGZXbKA6-ySdipabEwPkEAMO0LRNoRsDztv1h0aOw/exec";

async function obtenerNumeroTramite() {
  console.log("üîÑ Solicitando √∫ltimo n√∫mero de tr√°mite...");
  const resp = await fetch(`${scriptURL}?action=last`);
  const ultimo = await resp.text();
  console.log("üìÑ √öltimo tr√°mite en hoja:", ultimo);

  const year = new Date().getFullYear();
  let siguiente;
  if (!ultimo || ultimo === "0") {
    siguiente = `CZ5-8-G-${year}-0001`;
  } else {
    const partes = ultimo.split("-");
    const anioUltimo = partes[3];
    let num = parseInt(partes[4]);
    if (anioUltimo !== String(year)) num = 0;
    siguiente = `CZ5-8-G-${year}-${String(num + 1).padStart(4, '0')}`;
  }
  console.log("‚úÖ Siguiente n√∫mero de tr√°mite generado:", siguiente);
  return siguiente;
}

document.getElementById("formulario").addEventListener("submit", async function(event) {
  event.preventDefault();
  console.log("üìù Enviando formulario...");

  const datos = {
    numeroTramite: await obtenerNumeroTramite(),
    evento: document.getElementById("evento").value,
    presentadoPor: document.getElementById("presentadoPor").value,
    cedula: document.getElementById("cedula").value,
    lugar: document.getElementById("lugar").value,
    ciudad: document.getElementById("ciudad").value,
    provincia: document.getElementById("provincia").value,
    fechaEvento: document.getElementById("fechaEvento").value,
    horaInicio: document.getElementById("horaInicio").value,
    horaFin: document.getElementById("horaFin").value,
    aforo: document.getElementById("aforo").value,
    estado: document.getElementById("estado").value,
    fechaEmision: document.getElementById("fechaEmision").value
  };

  console.log("üì¶ Datos preparados:", datos);

  Swal.fire({
    title: `Generando nuevo certificado`,
    html: `Tr√°mite <b>${datos.numeroTramite}</b><br>Por favor, espera...`,
    allowOutsideClick: false,
    didOpen: () => { Swal.showLoading(); }
  });

  try {
    await guardarEnSheets(datos);
  } catch (err) {
    console.error("üî• Fall√≥ guardarEnSheets:", err);
    Swal.fire("Error", "Hubo un problema al guardar", "error");
  }
});

async function guardarEnSheets(datos) {
  console.log("üì§ Enviando datos a Google Apps Script...");

  // Enviar como FormData (lo que ya usabas), pero manejando respuesta robustamente.
  const formData = new FormData();
  for (let key in datos) formData.append(key, datos[key]);

  const res = await fetch(scriptURL, { method: "POST", body: formData });

  // Leemos SIEMPRE como texto y luego intentamos JSON.
  const raw = await res.text();
  console.log("üì• Respuesta cruda del servidor:", raw);

  let payload;
  try {
    payload = JSON.parse(raw);
    console.log("‚úÖ Respuesta interpretada como JSON:", payload);
  } catch (e) {
    console.warn("‚ö†Ô∏è No es JSON. Modo compatibilidad texto. Error parse:", e);
    payload = raw.trim();
  }

  // Modo JSON (nuevo doPost con PDF)
  if (typeof payload === "object" && payload !== null) {
    if (payload.status === "OK") {
      Swal.close();
      Swal.fire("√âxito", `Tr√°mite ${datos.numeroTramite} guardado correctamente`, "success");
      document.getElementById("formulario").reset();
      if (payload.pdf) {
        console.log("üìÑ Abriendo PDF:", payload.pdf);
        window.open(payload.pdf, "_blank");
      } else {
        console.log("‚ÑπÔ∏è No vino URL PDF en la respuesta JSON.");
      }
      return;
    } else {
      console.error("‚ùå Servidor devolvi√≥ ERROR:", payload.message);
      throw new Error(payload.message || "Error del servidor");
    }
  }

  // Modo texto (legacy "OK")
  if (typeof payload === "string" && payload.toUpperCase().includes("OK")) {
    Swal.close();
    Swal.fire("√âxito", `Tr√°mite ${datos.numeroTramite} guardado correctamente`, "success");
    document.getElementById("formulario").reset();
    console.log("‚ÑπÔ∏è Respuesta legacy 'OK' sin PDF. Si esperas PDF, aseg√∫rate de que tu doPost devuelva JSON.");
    return;
  }

  // Si lleg√≥ aqu√≠, es un error no reconocido
  console.error("‚ùå Respuesta inesperada del servidor:", payload);
  throw new Error("Respuesta inesperada del servidor");
}
</script>
</body>
</html>
