<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Certificado de Plan de Seguridad</title>
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap" rel="stylesheet"/>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; font-family: 'Roboto', sans-serif; }
    body { background-color: #f4f6f9; color: #333; padding-bottom: 70px; }
    header { background: #2F338F; color: white; text-align: center; padding: 1.5rem 1rem; box-shadow: 0 2px 5px rgba(0,0,0,0.15); }
    header img { max-height: 70px; display: block; margin: 0 auto 0.5rem; }
    header h1 { font-size: 1.4rem; font-weight: bold; }
    header p { font-size: 0.9rem; opacity: 0.9; }
    .container { max-width: 1000px; margin: 2rem auto; background: white; padding: 2rem; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
    h2 { text-align: center; color: #2F338F; font-size: 1.6rem; margin-bottom: 1.5rem; }
    label { font-size: 0.95rem; color: #555; margin-bottom: 4px; display: block; }
    input, select, button { width: 100%; padding: 12px; margin-top: 6px; border: 1px solid #ccc; border-radius: 8px; font-size: 1rem; transition: border-color 0.3s; }
    input:focus, select:focus { border-color: #2F338F; outline: none; }
    button { background-color: #2F338F; color: white; font-weight: bold; cursor: pointer; border: none; transition: background-color 0.3s ease; }
    button:hover { background-color: #24286a; }
    .form-section { margin-bottom: 1rem; }
    form { display: grid; grid-template-columns: 1fr 1fr; gap: 1rem 2rem; }
    form button { grid-column: span 2; }
    footer { position: fixed; bottom: 0; left: 0; width: 100%; background: #2F338F; color: white; text-align: center; padding: 0.8rem; font-size: 0.85rem; }
    @media (max-width: 768px) { form { grid-template-columns: 1fr; } form button { grid-column: span 1; } }
  </style>
</head>
<body>

<header>
  <img src="Logo el NUEVO ECUADOR.png" alt="Logo SNGRE">
  <h1>Secretar√≠a Nacional de Gesti√≥n de Riesgos</h1>
  <p>Coordinaci√≥n Zonal 5-8 | Uso Interno y Personal</p>
</header>

<div class="container">
  <h2>Certificado de Aprobaci√≥n de Plan de Seguridad</h2>

  <form id="formulario">
    <div class="form-section"><label>Evento Deportivo:</label><input type="text" id="evento" required></div>
    <div class="form-section"><label>Presentado por:</label><input type="text" id="presentadoPor" required></div>
    <div class="form-section"><label>C√©dula de Identidad:</label><input type="text" id="cedula" required></div>
    <div class="form-section"><label>Lugar del Evento:</label><input type="text" id="lugar" required></div>
    <div class="form-section"><label>Provincia:</label>
      <select id="provincia" required>
        <option value="">Seleccione una provincia</option>
        <option value="Guayas">Guayas</option>
      </select>
    </div>
    <div class="form-section"><label>Ciudad:</label>
      <select id="ciudad" required>
        <option value="">Seleccione una ciudad</option>
        <option value="Guayaquil">Guayaquil</option>
      </select>
    </div>
    <div class="form-section"><label>Fecha:</label><input type="date" id="fechaEvento" required></div>
    <div class="form-section"><label>Hora de inicio:</label><input type="time" id="horaInicio" required></div>
    <div class="form-section"><label>Hora de finalizaci√≥n:</label><input type="time" id="horaFin" required></div>
    <div class="form-section"><label>Aforo:</label><input type="number" id="aforo" required></div>
    <div class="form-section"><label>Estado del Tr√°mite:</label>
      <select id="estado" required>
        <option value="Aprobado">Aprobado</option>
        <option value="Rechazado">Rechazado</option>
      </select>
    </div>
    <div class="form-section"><label>Fecha de Emisi√≥n:</label><input type="date" id="fechaEmision" required></div>
    <button type="submit" id="generateBtn">Generar Certificado</button>
  </form>
</div>

<footer>
  ¬© 2025 Secretar√≠a Nacional de Gesti√≥n de Riesgos - CZ 5-8 | Uso Interno
</footer>

<script>
/** ‚úÖ Usa siempre el Worker para CORS + JSON */
const workerURL = "https://white-night-b8de.dylanvillasagua.workers.dev";

/** YYYY-MM-DD ‚Üí ‚Äú10 de agosto de 2025‚Äù (si la necesitas m√°s adelante) */
function formatearFechaLarga(iso) {
  if (!iso) return "";
  const d = new Date(iso + "T00:00:00");
  return d.toLocaleDateString("es-EC", { day: "numeric", month: "long", year: "numeric" });
}

/** Pide el √∫ltimo n√∫mero (JSON: {last}) y calcula el siguiente */
async function obtenerNumeroTramite() {
  console.log("üîÑ Solicitando √∫ltimo n√∫mero de tr√°mite v√≠a Worker...");
  const resp = await fetch(`${workerURL}?action=last`, { method: "GET" });
  const data = await resp.json();          // üëà ahora s√≠, JSON siempre
  const ultimo = (data && data.last) ? String(data.last) : "0";
  console.log("üìÑ √öltimo:", ultimo);

  const year = new Date().getFullYear();
  let siguiente;
  if (!ultimo || ultimo === "0") {
    siguiente = `CZ5-8-G-${year}-0001`;
  } else {
    const partes = ultimo.split("-");
    const anioUltimo = partes[3];
    let num = parseInt(partes[4], 10);
    if (anioUltimo !== String(year)) num = 0;
    siguiente = `CZ5-8-G-${year}-${String(num + 1).padStart(4, '0')}`;
  }
  console.log("‚úÖ Siguiente n√∫mero:", siguiente);
  return siguiente;
}

document.getElementById("formulario").addEventListener("submit", async (event) => {
  event.preventDefault();
  console.log("üìù Enviando formulario...");

  const datos = {
    numeroTramite: await obtenerNumeroTramite(),
    evento: document.getElementById("evento").value.trim(),
    presentadoPor: document.getElementById("presentadoPor").value.trim(),
    cedula: document.getElementById("cedula").value.trim(),
    lugar: document.getElementById("lugar").value.trim(),
    ciudad: document.getElementById("ciudad").value,
    provincia: document.getElementById("provincia").value,
    fechaEvento: document.getElementById("fechaEvento").value,
    horaInicio: document.getElementById("horaInicio").value,
    horaFin: document.getElementById("horaFin").value,
    aforo: document.getElementById("aforo").value,
    estado: document.getElementById("estado").value,
    fechaEmision: document.getElementById("fechaEmision").value
  };
  console.log("üì¶ Datos preparados:", datos);

  const confirm = await Swal.fire({
    title: 'Confirmar',
    text: `Se generar√° el tr√°mite: ${datos.numeroTramite}`,
    icon: 'question',
    showCancelButton: true,
    confirmButtonText: 'Generar',
    cancelButtonText: 'Cancelar'
  });
  if (!confirm.isConfirmed) return;

  Swal.fire({
    title: `Generando nuevo certificado\n${datos.numeroTramite}`,
    html: "Por favor, espera‚Ä¶",
    allowOutsideClick: false,
    didOpen: () => Swal.showLoading()
  });

  try {
    // Enviar como x-www-form-urlencoded
    const params = new URLSearchParams();
    Object.entries(datos).forEach(([k, v]) => params.append(k, v));

    console.log("üì§ POST ‚Üí Worker (x-www-form-urlencoded):", params.toString());
    const res = await fetch(workerURL, {
      method: "POST",
      headers: { "Content-Type": "application/x-www-form-urlencoded;charset=UTF-8" },
      body: params.toString()
    });

    // El Worker devuelve application/json SIEMPRE
    const payload = await res.json();
    console.log("‚úÖ Payload:", payload);

    if (payload && payload.status === "OK") {
      Swal.close();
      await Swal.fire("√âxito", `Tr√°mite ${datos.numeroTramite} guardado${payload.pdf ? " y PDF generado" : ""}.`, "success");
      document.getElementById("formulario").reset();
      if (payload.pdf) {
        console.log("üìÑ Abriendo PDF:", payload.pdf);
        window.open(payload.pdf, "_blank");
      }
      return;
    }

    console.error("‚ùå Respuesta inesperada:", payload);
    throw new Error("Respuesta inesperada del servidor");

  } catch (err) {
    console.error("üî• Error total:", err);
    Swal.close();
    Swal.fire("Error", "Hubo un problema al guardar/generar el PDF", "error");
  }
});
</script>
</body>
</html>
