<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Certificado de Plan de Seguridad</title>
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap" rel="stylesheet"/>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; font-family: 'Roboto', sans-serif; }
    body { background-color: #f4f6f9; color: #333; padding-bottom: 70px; }
    header { background: #2F338F; color: white; text-align: center; padding: 1.5rem 1rem; box-shadow: 0 2px 5px rgba(0,0,0,0.15); }
    header img { max-height: 70px; display: block; margin: 0 auto 0.5rem; }
    header h1 { font-size: 1.8rem; font-weight: bold; }
    header p { font-size: 0.9rem; opacity: 0.9; }
    .container { max-width: 1000px; margin: 2rem auto; background: white; padding: 2rem; border-radius: 16px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
    h2 { text-align: center; color: #2F338F; font-size: 1.6rem; margin-bottom: 1rem; }
    .hint { background:#f2f4ff; border:1px solid #e5e8ff; color:#2F338F; padding:.75rem 1rem; border-radius:12px; margin-bottom:1.25rem; display:flex; justify-content:space-between; align-items:center; gap:.75rem; }
    .hint small { opacity:.8; }
    label { font-size: 0.95rem; color: #555; margin-bottom: 4px; display: block; }
    input, select, button { width: 100%; padding: 12px; margin-top: 6px; border: 1px solid #ccc; border-radius: 10px; font-size: 1rem; transition: border-color 0.3s; }
    input:focus, select:focus { border-color: #2F338F; outline: none; }
    button { background-color: #2F338F; color: white; font-weight: bold; cursor: pointer; border: none; transition: background-color 0.3s ease; }
    button:hover { background-color: #24286a; }
    button[disabled] { opacity:.6; cursor:not-allowed; }
    .form-section { margin-bottom: 1rem; }
    form { display: grid; grid-template-columns: 1fr 1fr; gap: 1rem 2rem; }
    form button { grid-column: span 2; }
    footer { position: fixed; bottom: 0; left: 0; width: 100%; background: #2F338F; color: white; text-align: center; padding: 0.8rem; font-size: 0.85rem; }
    @media (max-width: 768px) { form { grid-template-columns: 1fr; } form button { grid-column: span 1; } }
  </style>
</head>
<body>

<header>
  <img src="Logo el NUEVO ECUADOR.png" alt="Logo SNGRE">
  <h1>Secretaría Nacional de Gestión de Riesgos</h1>
  <p>Coordinación Zonal 5-8 | Uso Interno y Personal</p>
</header>

<div class="container">
  <h2>Certificado de Aprobación de Plan de Seguridad</h2>

  <!-- Indicador del próximo número probable (preview) -->
  <div class="hint">
    <div>
      <div id="previewNumero"><strong>Próximo N° de trámite:</strong> <span>consultando…</span></div>
      <small>El número final lo asigna el servidor al guardar.</small>
    </div>
    <button type="button" id="refreshPreview" style="width:auto;padding:.5rem .8rem;border-radius:10px;">Actualizar</button>
  </div>

  <form id="formulario" autocomplete="off" novalidate>
    <div class="form-section">
      <label for="evento">Evento Deportivo:</label>
      <input type="text" id="evento" required>
    </div>

    <div class="form-section">
      <label for="presentadoPor">Presentado por:</label>
      <input type="text" id="presentadoPor" required>
    </div>

    <div class="form-section">
      <label for="cedula">Cédula de Identidad:</label>
      <input type="text" id="cedula" inputmode="numeric" required>
    </div>

    <div class="form-section">
      <label for="lugar">Lugar del Evento:</label>
      <input type="text" id="lugar" required>
    </div>

    <div class="form-section">
      <label for="provincia">Provincia:</label>
      <select id="provincia" required>
        <option value="">Seleccione una provincia</option>
        <option value="Guayas">Guayas</option>
      </select>
    </div>

    <div class="form-section">
      <label for="ciudad">Ciudad:</label>
      <select id="ciudad" required>
        <option value="">Seleccione una ciudad</option>
        <option value="Guayaquil">Guayaquil</option>
      </select>
    </div>

    <div class="form-section">
      <label for="fechaEvento">Fecha:</label>
      <input type="date" id="fechaEvento" required>
    </div>

    <div class="form-section">
      <label for="horaInicio">Hora de inicio:</label>
      <input type="time" id="horaInicio" required>
    </div>

    <div class="form-section">
      <label for="horaFin">Hora de finalización:</label>
      <input type="time" id="horaFin" required>
    </div>

    <div class="form-section">
      <label for="aforo">Aforo:</label>
      <input type="number" id="aforo" min="0" step="1" required>
    </div>

    <div class="form-section">
      <label for="estado">Estado del Trámite:</label>
      <select id="estado" required>
        <option value="Aprobado">Aprobado</option>
        <option value="Rechazado">Rechazado</option>
      </select>
    </div>

    <div class="form-section">
      <label for="fechaEmision">Fecha de Emisión:</label>
      <input type="date" id="fechaEmision" required>
    </div>

    <button type="submit" id="generateBtn">Generar Certificado</button>
  </form>
</div>

<footer>
  © 2025 Secretaría Nacional de Gestión de Riesgos - CZ 5-8 | Uso Interno
</footer>

<script>
const workerURL = "https://white-night-b8de.dylanvillasagua.workers.dev";
const required = v => v !== null && v !== undefined && String(v).trim() !== "";

/* Preview del siguiente número */
async function cargarPreview() {
  const el = document.querySelector("#previewNumero span");
  try {
    el.textContent = "consultando…";
    const res = await fetch(`${workerURL}?action=next`);
    const data = await res.json();
    el.textContent = data && data.nextPreview ? data.nextPreview : "(no disponible)";
  } catch (e) {
    console.error("Preview error:", e);
    el.textContent = "(error al consultar)";
  }
}
document.getElementById("refreshPreview").addEventListener("click", cargarPreview);
document.addEventListener("DOMContentLoaded", cargarPreview);

/* Envío del formulario */
document.getElementById("formulario").addEventListener("submit", async (event) => {
  event.preventDefault();

  const btn = document.getElementById("generateBtn");
  btn.disabled = true;

  const datos = {
    evento: document.getElementById("evento").value.trim(),
    presentadoPor: document.getElementById("presentadoPor").value.trim(),
    cedula: document.getElementById("cedula").value.trim(),
    lugar: document.getElementById("lugar").value.trim(),
    ciudad: document.getElementById("ciudad").value,
    provincia: document.getElementById("provincia").value,
    fechaEvento: document.getElementById("fechaEvento").value,
    horaInicio: document.getElementById("horaInicio").value,
    horaFin: document.getElementById("horaFin").value,
    aforo: document.getElementById("aforo").value,
    estado: document.getElementById("estado").value,
    fechaEmision: document.getElementById("fechaEmision").value
  };

  const oblig = ["evento","presentadoPor","cedula","lugar","ciudad","provincia","fechaEvento","horaInicio","horaFin","aforo","estado","fechaEmision"];
  const faltantes = oblig.filter(k => !required(datos[k]));
  if (faltantes.length) {
    btn.disabled = false;
    await Swal.fire("Completa los campos", "Faltan: " + faltantes.join(", "), "warning");
    return;
  }

  const confirm = await Swal.fire({
    title: "Confirmar",
    text: "Se generará el número de trámite y el PDF.",
    icon: "question",
    showCancelButton: true,
    confirmButtonText: "Generar",
    cancelButtonText: "Cancelar"
  });
  if (!confirm.isConfirmed) { btn.disabled = false; return; }

  Swal.fire({
    title: "Generando certificado",
    html: "Por favor, espera…",
    allowOutsideClick: false,
    didOpen: () => Swal.showLoading()
  });

  try {
    const params = new URLSearchParams();
    Object.entries(datos).forEach(([k, v]) => params.append(k, v));

    const res = await fetch(workerURL, {
      method: "POST",
      headers: { "Content-Type": "application/x-www-form-urlencoded;charset=UTF-8" },
      body: params.toString()
    });

    const payload = await res.json();
    console.log("Respuesta backend:", payload);

    if (payload && payload.status === "OK") {
      const numero = payload.numeroTramite || "(sin número)";
      Swal.close();
      await Swal.fire("Éxito", `Trámite ${numero} guardado${payload.pdf ? " y PDF generado" : ""}.`, "success");
      document.getElementById("formulario").reset();
      if (payload.pdf) window.open(payload.pdf, "_blank");
      cargarPreview(); // actualizar el siguiente número
    } else {
      const msg = (payload && (payload.message || payload.error)) || "Respuesta inesperada del servidor";
      throw new Error(msg);
    }
  } catch (err) {
    console.error("Error total:", err);
    Swal.close();
    await Swal.fire("Error", (err && err.message) ? err.message : "Hubo un problema al guardar/generar el PDF", "error");
  } finally {
    btn.disabled = false;
  }
});
</script>
</body>
</html>
