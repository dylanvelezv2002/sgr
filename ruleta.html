<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Ruleta de Rifa ‚Äî Fullscreen</title>
<style>
  :root{
    --bg:#0a0f1f; --ink:#e9f2ff; --glow:#73f5ff; --accent:#8b5cf6; --warn:#f59e0b; --ok:#10b981;
  }
  *{box-sizing:border-box} html,body{height:100%}
  body{
    margin:0; font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Arial;
    color:var(--ink);
    background:
      radial-gradient(1200px 800px at 15% -10%, #1a2350 0%, transparent 55%),
      radial-gradient(1200px 800px at 120% 120%, #16224a 0%, transparent 55%),
      var(--bg);
    overflow:hidden;
  }
  /* Lienzo full */
  .stage{position:fixed; inset:0; display:grid; place-items:center}
  .wheelBox{position:relative; width:min(82vmin, 92vw); aspect-ratio:1; filter:drop-shadow(0 30px 60px rgba(0,0,0,.45))}
  canvas{width:100%; height:100%; display:block; border-radius:50%}
  .pointer{
    position:absolute; inset:auto 0 100% 0; margin:auto; width:0; height:0;
    border-left:22px solid transparent; border-right:22px solid transparent; border-bottom:34px solid var(--warn);
    filter:drop-shadow(0 8px 10px rgba(0,0,0,.6));
  }
  .hud{
    position:fixed; left:50%; bottom:3.6vmin; transform:translateX(-50%);
    display:flex; gap:10px; align-items:center; flex-wrap:wrap; justify-content:center;
  }
  button{
    border:0; border-radius:999px; padding:12px 18px; font-weight:800; letter-spacing:.2px; cursor:pointer;
    background:linear-gradient(135deg, #67e8f9, #8b5cf6); color:#06121a;
    box-shadow:0 14px 40px rgba(115,245,255,.25); transition:transform .08s ease, filter .2s;
  }
  button:active{transform:translateY(1px)}
  button:disabled{opacity:.6; cursor:not-allowed}
  .ghost{background:#172554; color:var(--ink); box-shadow:none; border:1px solid rgba(255,255,255,.08)}
  .ok{background:linear-gradient(135deg,#34d399,#10b981); color:#042015}
  .badge{background:#0f1b46; border:1px solid rgba(255,255,255,.08); padding:6px 10px; border-radius:999px}
  .toggle{display:flex; align-items:center; gap:8px; background:#0f1b46; border:1px solid rgba(255,255,255,.08); padding:8px 12px; border-radius:999px}
  .toggle input{transform:scale(1.2)}
  /* Cartel ganador */
  .winner{
    position:fixed; inset:0; display:none; place-items:center; backdrop-filter:blur(6px);
    background:rgba(8,12,26,.45); z-index:10;
  }
  .winCard{
    background:linear-gradient(180deg, rgba(255,255,255,.07), rgba(255,255,255,.03));
    border:1px solid rgba(255,255,255,.12); border-radius:20px; padding:22px 26px; text-align:center;
    box-shadow:0 30px 80px rgba(0,0,0,.5);
  }
  .winTitle{font-size:clamp(18px,2.2vmax,22px); opacity:.9; margin:0 0 8px}
  .winName{font-size:clamp(26px,4.5vmax,56px); font-weight:900; margin:6px 0 2px; color:#fff;
           text-shadow:0 0 18px rgba(115,245,255,.35)}
  .winNum{font-size:clamp(16px,2vmax,22px); opacity:.9; margin:0 0 14px}
  .winActions{display:flex; gap:10px; justify-content:center; flex-wrap:wrap}
  /* Confeti */
  #confetti{position:fixed; inset:0; pointer-events:none}
  /* Pie m√≠nimo */
  .note{position:fixed; left:14px; bottom:10px; opacity:.6; font-size:12px}
</style>
</head>
<body>
<canvas id="confetti"></canvas>

<div class="stage">
  <div class="wheelBox">
    <div class="pointer"></div>
    <canvas id="wheel" width="1000" height="1000" aria-label="ruleta"></canvas>
  </div>

  <div class="hud">
    <button id="spinBtn">üé° Girar</button>
    <label class="toggle"><input id="noRepeat" type="checkbox" checked> Evitar repetidos</label>
    <span class="badge" id="countBadge">0 participantes</span>
    <button class="ghost" id="shuffleBtn" title="Mezclar orden y colores">üîÄ Mezclar</button>
    <button class="ghost" id="resetBtn">üîÑ Reset vista</button>
    <button class="ok" id="exportBtn">‚¨áÔ∏è Exportar ganadores</button>
  </div>
</div>

<!-- Cartel ganador -->
<div class="winner" id="winnerModal" role="dialog" aria-modal="true">
  <div class="winCard">
    <p class="winTitle">üéâ Ganador</p>
    <p class="winName" id="winName">‚Äî</p>
    <p class="winNum" id="winNum">‚Äî</p>
    <div class="winActions">
      <button id="closeModal" class="ghost">Cerrar</button>
      <button id="keepBtn" class="ghost">Mantener en ruleta</button>
      <button id="removeBtn" class="ok">Eliminar de la ruleta</button>
    </div>
  </div>
</div>

<div class="note">Ruleta fullscreen ‚Ä¢ sin librer√≠as ‚Ä¢ animaci√≥n suave con *ticks*</div>

<script>
/*** ======================= Datos ======================= ***/
let people = [
  {n:1,   name:"Ronald Alb√°n"},
  {n:5,   name:"Sebastian Andrade"},
  {n:7,   name:"David Ledesma"},
  {n:8,   name:"Ronald Alb√°n"},
  {n:9,   name:"David Ledesma"},
  {n:23,  name:"Elsita"},
  {n:25,  name:"Ermel Avilez"},
  {n:40,  name:"Elsita"},
  {n:45,  name:"Mery Alvarado Carbo"},
  {n:50,  name:"Thiago Chela"},
  {n:69,  name:"David Ledesma"},
  {n:77,  name:"Noem√≠ Mej√≠a"},
  {n:90,  name:"Kebin Gaglay"},
  {n:100, name:"GABRIELA LINCANGO"},
  {n:145, name:"Mery Alvarado Carbo"},
  {n:98,  name:"Jose Smith"},
  {n:89,  name:"Jose Smith"},
  {n:20,  name:"Narcisa Briones"},
  {n:16,  name:"Narcisa Briones"},
  {n:83,  name:"Luis Rosero"},
  {n:116, name:"Luis Rosero"},
  {n:15,  name:"JEFFERSON LLANGA"}
];

/*** =================== Elementos/UI =================== ***/
const wheel = document.getElementById('wheel');
const ctx = wheel.getContext('2d');
const spinBtn = document.getElementById('spinBtn');
const noRepeat = document.getElementById('noRepeat');
const shuffleBtn = document.getElementById('shuffleBtn');
const resetBtn = document.getElementById('resetBtn');
const exportBtn = document.getElementById('exportBtn');
const countBadge = document.getElementById('countBadge');
const winnerModal = document.getElementById('winnerModal');
const winName = document.getElementById('winName');
const winNum  = document.getElementById('winNum');
const closeModal = document.getElementById('closeModal');
const keepBtn = document.getElementById('keepBtn');
const removeBtn = document.getElementById('removeBtn');

/*** =================== Estado/Animaci√≥n =================== ***/
let angle = 0;           // rad
let vel = 0;             // rad/s
let spinning = false;
let lastTickSector = -1;
let lastTime = performance.now();
let history = [];

const COLORS = ["#8b5cf6","#06b6d4","#f59e0b","#34d399","#ef4444","#3b82f6","#a855f7","#10b981",
                "#eab308","#f472b6","#22d3ee","#84cc16","#fb7185","#60a5fa","#2dd4bf","#f97316"];

function color(i){ return COLORS[i % COLORS.length]; }
function shuffle(arr){ arr.sort(()=>Math.random()-0.5); return arr; }

/*** =================== Dibujo de ruleta =================== ***/
function drawWheel(activeIndex=-1){
  const r = wheel.width/2;
  ctx.clearRect(0,0,wheel.width,wheel.height);
  ctx.save(); ctx.translate(r,r); ctx.rotate(angle);

  const n = Math.max(1, people.length);
  const arc = (Math.PI*2)/n;

  for(let i=0;i<n;i++){
    // fondo del sector
    ctx.beginPath(); ctx.moveTo(0,0);
    ctx.arc(0,0,r-10, i*arc, (i+1)*arc); ctx.closePath();
    ctx.fillStyle = i===activeIndex ? "#fff" : color(i);
    ctx.fill();

    // separaci√≥n
    ctx.lineWidth = 2; ctx.strokeStyle = "rgba(255,255,255,.38)"; ctx.stroke();

    // etiqueta
    ctx.save();
    ctx.rotate(i*arc + arc/2);
    ctx.textAlign="right";
    ctx.font = `${Math.max(16, r*0.048)}px system-ui,sans-serif`;
    const e = people[i] ?? {n:"‚Äî", name:"(vac√≠o)"};
    const text = `#${e.n} ¬∑ ${e.name}`;
    const w = ctx.measureText(text).width;
    ctx.translate(r*0.93,0);
    // cartela
    ctx.fillStyle = i===activeIndex ? "rgba(15,22,48,.95)" : "rgba(255,255,255,.93)";
    ctx.fillRect(-w-12,-18, w+16,36);
    ctx.fillStyle = i===activeIndex ? "#d7edff" : "#0b1020";
    ctx.fillText(text, -8, 8);
    ctx.restore();
  }
  // disco central
  ctx.beginPath(); ctx.arc(0,0,r*0.12,0,Math.PI*2);
  ctx.fillStyle="#0c132b"; ctx.fill();
  ctx.lineWidth=3; ctx.strokeStyle="rgba(255,255,255,.35)"; ctx.stroke();
  ctx.fillStyle="#e6f4ff"; ctx.font=`${Math.max(18, r*0.06)}px ui-sans-serif`;
  ctx.textAlign="center"; ctx.fillText("¬°Suerte!",0,8);
  ctx.restore();
}

/*** ============ Selector / l√≥gica de sector activo ============ ***/
function currentIndex(){
  const n = Math.max(1, people.length);
  const arc = (Math.PI*2)/n;
  // puntero arriba: -90¬∞
  const corrected = (angle + Math.PI/2) % (Math.PI*2);
  const idx = (n - Math.floor(corrected / arc) - 1 + n) % n;
  return idx;
}

/*** =================== Animaci√≥n con ticks =================== ***/
const tickAudio = new (window.AudioContext||window.webkitAudioContext)();
function playTick(){
  try{
    const o = tickAudio.createOscillator();
    const g = tickAudio.createGain();
    o.type="square"; o.frequency.value=900;
    g.gain.setValueAtTime(0.0001, tickAudio.currentTime);
    g.gain.exponentialRampToValueAtTime(0.08, tickAudio.currentTime + 0.01);
    g.gain.exponentialRampToValueAtTime(0.0001, tickAudio.currentTime + 0.08);
    o.connect(g); g.connect(tickAudio.destination); o.start(); o.stop(tickAudio.currentTime+0.09);
  }catch{}
}

function animate(){
  const now = performance.now();
  const dt = (now - lastTime)/1000; lastTime = now;
  if(spinning){
    angle = (angle + vel*dt) % (Math.PI*2);
    // fricci√≥n suave
    vel *= 0.985;
    // tick por cruce de sector
    const idx = currentIndex();
    if(idx !== lastTickSector){ playTick(); lastTickSector = idx; }
    // stop
    if(vel < 0.25){ // umbral
      spinning = false; vel = 0;
      showWinner(idx);
      confettiBurst();
    }
  }
  drawWheel(spinning ? currentIndex() : -1);
  requestAnimationFrame(animate);
}
requestAnimationFrame(animate);

/*** =================== Acciones =================== ***/
spinBtn.addEventListener('click', ()=>{
  if(spinning || people.length===0) return;
  // velocidad inicial aleatoria + vueltas grandes
  const n = people.length;
  const minTurns = 6, maxTurns = 9;
  const base = (Math.PI*2)* (Math.random()*(maxTurns-minTurns)+minTurns);
  // peque√±a variaci√≥n para caer aleatorio
  const extra = (Math.random()* (Math.PI*2));
  const targetDelta = base + extra;
  // convertir a velocidad inicial para frenado exponencial:
  // v0 ‚âà targetDelta * (1 - decay) / dt_equiv; usamos heur√≠stica:
  vel = 10 + Math.random()*4; // rad/s inicial
  spinning = true; spinBtn.disabled = true;
  // reactivar bot√≥n cuando termine (lo hace showWinner)
});

shuffleBtn.addEventListener('click', ()=>{
  shuffle(people); lastTickSector = -1; drawWheel();
  updateCount();
});

resetBtn.addEventListener('click', ()=>{ angle=0; vel=0; spinning=false; lastTickSector=-1; drawWheel(); });

exportBtn.addEventListener('click', ()=>{
  if(!history.length) return;
  const rows = [["numero","nombre","fecha"]];
  history.forEach(h=>rows.push([h.n, h.name, new Date(h.ts).toLocaleString('es-EC')]));
  const csv = rows.map(r=>r.join(',')).join('\n');
  const blob = new Blob([csv], {type:"text/csv;charset=utf-8;"});
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = 'ganadores.csv';
  a.click();
  URL.revokeObjectURL(a.href);
});

function updateCount(){ countBadge.textContent = `${people.length} participante${people.length!==1?'s':''}`; }
updateCount();

/*** =================== Ganador (modal) =================== ***/
function showWinner(idx){
  const w = people[idx];
  history.unshift({n:w.n, name:w.name, ts:Date.now()});
  winName.textContent = w.name;
  winNum.textContent = `N¬∫ ${w.n}`;
  winnerModal.style.display = "grid";
  spinBtn.disabled = false;
  // decisi√≥n por defecto seg√∫n toggle
  if(noRepeat.checked){
    removeBtn.style.display = ''; keepBtn.style.display = '';
  }else{
    removeBtn.style.display = 'none'; keepBtn.style.display = '';
  }
}

closeModal.addEventListener('click', ()=> winnerModal.style.display='none');
keepBtn.addEventListener('click', ()=> winnerModal.style.display='none');
removeBtn.addEventListener('click', ()=>{
  const name = winName.textContent;
  const num  = Number(winNum.textContent.replace(/\D/g,''));
  const i = people.findIndex(p=>p.n===num && p.name===name);
  if(i>-1){ people.splice(i,1); updateCount(); }
  winnerModal.style.display='none';
});

/*** =================== Confeti =================== ***/
const conf = document.getElementById('confetti'); const cfx = conf.getContext('2d');
function sizeConf(){ conf.width = innerWidth; conf.height = innerHeight; }
addEventListener('resize', sizeConf); sizeConf();

function confettiBurst(){
  const P = Array.from({length: 160}, ()=>({
    x: innerWidth/2, y: 90, vx:(Math.random()*8-4), vy:(Math.random()*5+2),
    s: Math.random()*4+3, a: Math.random()*Math.PI*2, va: (Math.random()-.5)*0.4,
    col: COLORS[Math.floor(Math.random()*COLORS.length)], life: Math.random()*1200+800
  }));
  const t0 = performance.now();
  (function frame(t){
    const dt = (t - t0);
    cfx.clearRect(0,0,conf.width, conf.height);
    P.forEach(p=>{
      p.x += p.vx; p.y += p.vy; p.vy += 0.06; p.a += p.va;
      cfx.save(); cfx.translate(p.x,p.y); cfx.rotate(p.a);
      cfx.fillStyle = p.col; cfx.fillRect(-p.s/2,-p.s/2,p.s,p.s);
      cfx.restore();
    });
    if(dt < Math.max(...P.map(p=>p.life))) requestAnimationFrame(frame);
  })(performance.now());
}

/*** =================== Ajustes iniciales =================== ***/
function fitCanvas(){
  // render n√≠tido en pantallas HiDPI
  const scale = devicePixelRatio || 1;
  const box = wheel.getBoundingClientRect();
  wheel.width = Math.floor(box.width * scale);
  wheel.height = Math.floor(box.height * scale);
  ctx.setTransform(scale,0,0,scale,0,0); // compensar
  drawWheel();
}
new ResizeObserver(fitCanvas).observe(document.querySelector('.wheelBox'));
fitCanvas();
</script>
</body>
</html>
