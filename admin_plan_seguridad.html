<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Panel de Administraci√≥n ‚Äî Certificados</title>
<link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap" rel="stylesheet"/>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<style>
  *{box-sizing:border-box;margin:0;padding:0;font-family:'Roboto',sans-serif}
  body{background:#f4f6f9;color:#333;padding-bottom:70px}
  header{background:#2F338F;color:#fff;text-align:center;padding:1.5rem 1rem;box-shadow:0 2px 5px rgba(0,0,0,.15)}
  header img{max-height:70px;display:block;margin:0 auto .5rem}
  header h1{font-size:1.8rem;font-weight:bold}
  header p{font-size:.9rem;opacity:.9}
  .wrap{max-width:1100px;margin:1.5rem auto;background:#fff;padding:1.25rem;border-radius:16px;box-shadow:0 4px 15px rgba(0,0,0,.1)}
  h2{color:#2F338F;font-size:1.2rem;margin:0 0 .75rem}
  .kpis{display:grid;grid-template-columns:repeat(3,1fr);gap:.75rem;margin-bottom:1rem}
  .card{background:#fff;border:1px solid #e5e7eb;border-radius:12px;padding:.9rem}
  .card h3{font-size:.95rem;color:#4b5563;margin-bottom:.35rem}
  .card .num{font-size:1.6rem;font-weight:700}
  .toolbar{display:flex;flex-wrap:wrap;gap:.5rem;margin-bottom:.75rem}
  input,select,button{padding:10px 12px;border:1px solid #ccc;border-radius:10px;font-size:1rem}
  input{flex:1;min-width:220px}
  button{background:#2F338F;color:#fff;font-weight:700;cursor:pointer;border:none}
  button.secondary{background:#eef2ff;color:#2F338F;border:1px solid #c7ccff}
  button[disabled]{opacity:.6;cursor:not-allowed}
  .grid{overflow:auto;border-radius:12px;border:1px solid #e5e7eb}
  table{width:100%;border-collapse:collapse;background:#fff}
  th,td{border-bottom:1px solid #f0f1f4;padding:10px;font-size:.95rem;white-space:nowrap}
  th{background:#f9fafb;text-align:left;position:sticky;top:0;z-index:1}
  tr:hover td{background:#fafafa}
  .pill{padding:4px 8px;border-radius:999px;font-size:.8rem}
  .ok{background:#e8fff0;color:#065f46}.bad{background:#fee2e2;color:#991b1b}
  .section{display:grid;grid-template-columns:2fr 1fr;gap:1rem;margin-top:1rem}
  .muted{color:#6b7280;font-size:.85rem}
  .row{display:grid;grid-template-columns:1fr 1fr;gap:.5rem;margin-bottom:.5rem}
  footer{position:fixed;bottom:0;left:0;width:100%;background:#2F338F;color:#fff;text-align:center;padding:.8rem;font-size:.85rem}
  @media (max-width:900px){.section{grid-template-columns:1fr}.kpis{grid-template-columns:1fr}}
</style>
</head>
<body>
<header>
  <img src="Logo el NUEVO ECUADOR.png" alt="Logo SNGRE">
  <h1>Secretar√≠a Nacional de Gesti√≥n de Riesgos</h1>
  <p>Coordinaci√≥n Zonal 5-8 | Uso Interno y Personal</p>
</header>

<div class="wrap">
  <h2>Listado</h2>

  <div class="kpis">
    <div class="card"><h3>Total</h3><div class="num" id="k_total">-</div></div>
    <div class="card"><h3>Aprobados</h3><div class="num" id="k_ok">-</div></div>
    <div class="card"><h3>Rechazados</h3><div class="num" id="k_bad">-</div></div>
  </div>

  <div class="toolbar">
    <input id="q" placeholder="Buscar (n¬∞ tr√°mite, evento, solicitante, ciudad‚Ä¶)">
    <select id="orderBy">
      <option value="N¬∞ de Tr√°mite" selected>N¬∞ de Tr√°mite</option>
      <option value="Fecha de Emisi√≥n">Fecha de Emisi√≥n</option>
      <option value="Evento Deportivo">Evento</option>
      <option value="Presentado por">Presentado por</option>
      <option value="Estado del Tr√°mite">Estado</option>
    </select>
    <select id="dir"><option value="desc" selected>Desc</option><option value="asc">Asc</option></select>
    <select id="ps"><option>10</option><option selected>20</option><option>50</option><option>100</option></select>
    <button id="refresh">Actualizar</button>
    <button id="sync" class="secondary" title="Sincroniza el contador con la hoja">Sincronizar correlativo</button>
  </div>

  <div class="grid">
    <table>
      <thead>
        <tr>
          <th>#</th>
          <th>N¬∞ de Tr√°mite</th>
          <th>Evento</th>
          <th>Presentado por</th>
          <th>Ciudad</th>
          <th>Fecha Emisi√≥n</th>
          <th>Estado</th>
          <th>PDF</th>
          <th>Acciones</th>
        </tr>
      </thead>
      <tbody id="tbody">
        <tr><td colspan="9" style="text-align:center">Cargando‚Ä¶</td></tr>
      </tbody>
    </table>
  </div>

  <div class="section">
    <div class="card">
      <h2>Editar registro</h2>
      <div id="editInfo" class="muted">Selecciona una fila.</div>
      <div id="editForm" style="display:none;">
        <div class="row">
          <div>
            <label>Estado del Tr√°mite</label>
            <select id="f_Estado">
              <option value="">(vac√≠o)</option>
              <option value="Aprobado">Aprobado</option>
              <option value="Rechazado">Rechazado</option>
            </select>
          </div>
          <div>
            <label>Fecha de Emisi√≥n</label>
            <input type="date" id="f_FechaEmision">
          </div>
        </div>
        <div class="row">
          <div>
            <label>Observaciones (opcional)</label>
            <input id="f_Observaciones" placeholder="Observaciones internas">
          </div>
          <div>
            <label>URL PDF</label>
            <input id="f_PdfUrl" placeholder="https://‚Ä¶">
          </div>
        </div>
        <div class="row">
          <button id="save">Guardar cambios</button>
        </div>
      </div>
    </div>

    <div class="card">
      <h2>Ayuda</h2>
      <div class="muted">
        Este panel llama a tu <b>Cloudflare Worker</b>:
        <div style="margin:.4rem 0 .2rem .2rem">
          ‚Ä¢ Admin: <code>/panel?action=‚Ä¶</code><br/>
          ‚Ä¢ Sync: <code>/?action=sync</code>
        </div>
      </div>
    </div>
  </div>
</div>

<footer>
  ¬© 2025 Secretar√≠a Nacional de Gesti√≥n de Riesgos - CZ 5-8 | Uso Interno
</footer>

<script>
  // üìå ENDPOINTS
  const API_PANEL = "https://white-night-b8de.dylanvillasagua.workers.dev/panel"; // admin (list/get/update/regen)
  const API_FORM  = "https://white-night-b8de.dylanvillasagua.workers.dev/";      // sync (ra√≠z del formulario)

  // Estado UI
  const state = { page:1, ps:20, q:'', orderBy:'N¬∞ de Tr√°mite', dir:'desc', selected:null, pdfHeader:null };

  // Helpers
  const $ = (id)=>document.getElementById(id);
  const val = (id)=>$(id).value;
  const setVal = (id,v)=>$(id).value=(v??'');
  const debounce = (fn,ms)=>{let t;return (...a)=>{clearTimeout(t);t=setTimeout(()=>fn(...a),ms);}};
  const safe = (v)=> (v===undefined||v===null)?'':String(v);
  const badge = (s)=> (String(s||'').toLowerCase()==='aprobado')
                      ? '<span class="pill ok">Aprobado</span>'
                      : '<span class="pill bad">Rechazado</span>';

  // Eventos UI
  $('ps').addEventListener('change', ()=>{ state.ps=+val('ps'); load(); });
  $('orderBy').addEventListener('change', ()=>{ state.orderBy=val('orderBy'); load(); });
  $('dir').addEventListener('change', ()=>{ state.dir=val('dir'); load(); });
  $('q').addEventListener('input', debounce(()=>{ state.q=val('q'); state.page=1; load(); }, 300));
  $('refresh').addEventListener('click', load);
  $('sync').addEventListener('click', doSync);
  $('save').addEventListener('click', saveEdit);

  // Cargar lista
  async function load(){
    try{
      const u = new URL(API_PANEL);
      u.searchParams.set("action","list");
      u.searchParams.set("page", state.page);
      u.searchParams.set("pageSize", state.ps);
      u.searchParams.set("search", state.q);
      u.searchParams.set("orderBy", state.orderBy);
      u.searchParams.set("orderDir", state.dir);

      const res = await fetch(u, { headers:{ "Accept":"application/json" }});
      const text = await res.text();
      let data; try { data = JSON.parse(text) } catch { data = { raw:text }; }

      if (data.error){ throw new Error(data.error); }

      // KPIs (solo Total/Aprobados/Rechazados)
      const stats = {
        total: data?.stats?.total ?? (Array.isArray(data)?data.length:0),
        aprobados: data?.stats?.aprobados ?? 0,
        rechazados: data?.stats?.rechazados ?? 0
      };
      $('k_total').textContent = stats.total;
      $('k_ok').textContent    = stats.aprobados;
      $('k_bad').textContent   = stats.rechazados;

      const rows = Array.isArray(data?.rows) ? data.rows : (Array.isArray(data) ? data : []);
      const tb = $('tbody'); tb.innerHTML='';

      rows.forEach(r=>{
        const pdf = r.PDF || r['URL PDF'] || r.PdfUrl || '';
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${r.__row??''}</td>
          <td>${safe(r['N¬∞ de Tr√°mite'] || r.numeroTramite)}</td>
          <td>${safe(r['Evento Deportivo'] || r.evento)}</td>
          <td>${safe(r['Presentado por'] || r.presentadoPor)}</td>
          <td>${safe(r['Ciudad'] || r.ciudad)}</td>
          <td>${safe(r['Fecha de Emisi√≥n'] || r.fechaEmision || '')}</td>
          <td>${badge(r['Estado del Tr√°mite'] || r.estado)}</td>
          <td>${pdf ? `<a href="${pdf}" target="_blank">Abrir</a>` : ''}</td>
          <td>
            <button class="secondary" onclick="openRow(${r.__row})">Editar</button>
            <button class="secondary" onclick="copyLink('${pdf||''}')">Copiar</button>
            <button class="secondary" onclick="regen(${r.__row})">Regenerar</button>
          </td>`;
        tb.appendChild(tr);
      });

    }catch(err){
      console.error(err);
      Swal.fire("Error", err.message || "No se pudo cargar la lista", "error");
    }
  }

  // Abrir fila
  async function openRow(row){
    try{
      const u = new URL(API_PANEL);
      u.searchParams.set("action","get");
      u.searchParams.set("row", row);
      const res = await fetch(u);
      const rec = await res.json();
      if (rec.error) throw new Error(rec.error);

      state.selected = rec.__row;
      state.pdfHeader = rec._pdfHeader || null;

      $('editInfo').style.display='none';
      $('editForm').style.display='block';

      setVal('f_Estado', rec['Estado del Tr√°mite'] || rec.estado || '');
      setVal('f_FechaEmision', (rec.FechaEmisionISO || '').slice(0,10));
      setVal('f_Observaciones', rec.Observaciones || '');
      const pdfVal = rec.PDF || rec['URL PDF'] || rec.PdfUrl || '';
      setVal('f_PdfUrl', pdfVal);

      window.scrollTo({ top: document.body.scrollHeight, behavior:'smooth' });
    }catch(e){
      console.error(e);
      Swal.fire("Error", e.message || "No se pudo abrir el registro", "error");
    }
  }

  // Guardar cambios
  async function saveEdit(){
    if (!state.selected) return;
    const params = new URLSearchParams();
    params.set("action","update");
    params.set("__row", String(state.selected));
    params.set("Estado del Tr√°mite", val('f_Estado'));
    params.set("Fecha de Emisi√≥n", val('f_FechaEmision'));
    params.set("Observaciones", val('f_Observaciones'));
    if (state.pdfHeader) params.set(state.pdfHeader, val('f_PdfUrl'));

    const res = await fetch(API_PANEL, {
      method:"POST",
      headers:{ "Content-Type":"application/x-www-form-urlencoded;charset=UTF-8" },
      body: params.toString()
    });
    const out = await res.json();
    if (!out.ok){ Swal.fire("Error","No se pudo guardar","error"); return; }
    Swal.fire("Guardado","Cambios aplicados","success");
    load();
  }

  // Regenerar PDF
  async function regen(row){
    try{
      const u = new URL(API_PANEL);
      u.searchParams.set("action","regen");
      u.searchParams.set("row", row);
      const res = await fetch(u);
      const d = await res.json().catch(()=>({}));
      if (!d || d.error || d.ok===false){
        Swal.fire("Aviso","Regenerar no disponible en el backend (action=regen).","warning");
        return;
      }
      if (d.pdf){ window.open(d.pdf, "_blank"); }
      Swal.fire("Listo","PDF regenerado","success");
      load();
    }catch(e){
      Swal.fire("Error","No se pudo regenerar","error");
    }
  }

  // Copiar link PDF
  function copyLink(url){
    if (!url){ Swal.fire("Aviso","No hay URL de PDF en la fila.","info"); return; }
    navigator.clipboard.writeText(url);
    Swal.fire("Copiado","Enlace copiado al portapapeles","success");
  }

  // Sincronizar correlativo (llama a la ra√≠z del worker ‚Üí Apps Script del formulario)
  async function doSync(){
    try{
      const res = await fetch(API_FORM + "?action=sync");
      const js = await res.json();
      Swal.fire("Sincronizado", "seq="+(js.syncedTo??"-")+" | next="+(js.nextPreview??"-"), "success");
    }catch(e){
      Swal.fire("Error","No se pudo sincronizar","error");
    }
  }

  // Init
  document.addEventListener('DOMContentLoaded', load);
</script>
</body>
</html>
